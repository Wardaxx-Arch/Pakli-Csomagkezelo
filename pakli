#!/bin/bash

telepits_yay() {
    echo "üîß Yay telep√≠t√©se folyamatban..."
    sudo pacman -S --needed --noconfirm base-devel git || return 1
    git clone https://aur.archlinux.org/yay.git /tmp/yay || return 1
    cd /tmp/yay || { echo "‚ùå Nem siker√ºlt a yay k√∂nyvt√°rba l√©pni."; return 1; }
    makepkg -si --noconfirm || { echo "‚ùå A yay telep√≠t√©se sikertelen."; return 1; }
    cd - >/dev/null
    rm -rf /tmp/yay
    echo "‚úÖ Yay telep√≠tve."
}

detect_package_manager() {
    if command -v pacman >/dev/null 2>&1; then
        echo "pacman"
    elif command -v apt >/dev/null 2>&1; then
        echo "apt"
    elif command -v dnf >/dev/null 2>&1; then
        echo "dnf"
    elif command -v zypper >/dev/null 2>&1; then
        echo "zypper"
    elif command -v apk >/dev/null 2>&1; then
        echo "apk"
    else
        echo ""
    fi
}

PKG_MANAGER=$(detect_package_manager)

if [ -z "$PKG_MANAGER" ]; then
    echo "‚ùå Nem tal√°lhat√≥ t√°mogatott csomagkezel≈ë ezen a rendszeren."
    exit 1
fi

if [ $# -eq 0 ]; then
    echo "Haszn√°lat: pakli [parancs] [csomagok]"
    echo "Haszn√°lhat√≥ parancsok: -Syu, -Ss, -S, -R, -h"
    exit 1
fi

case "$1" in
    -Syu)
        echo "üîÑ Rendszer friss√≠t√©se..."
        case "$PKG_MANAGER" in
            pacman) sudo pacman -Syu ;;
            apt) sudo apt update && sudo apt upgrade ;;
            dnf) sudo dnf upgrade --refresh ;;
            zypper) sudo zypper refresh && sudo zypper update ;;
            apk) sudo apk update && sudo apk upgrade ;;
        esac
        ;;

    -Ss)
        shift
        if [ $# -eq 0 ]; then
            echo "K√©rlek adj meg keres√©si kulcssz√≥t."
            exit 1
        fi
        case "$PKG_MANAGER" in
            pacman) pacman -Ss "$@" || yay -Ss "$@" ;;
            apt) apt search "$@" ;;
            dnf) dnf search "$@" ;;
            zypper) zypper search "$@" ;;
            apk) apk search "$@" ;;
        esac
        ;;

    -S)
        shift
        if [ $# -eq 0 ]; then
            echo "Adj meg legal√°bb egy csomagot."
            exit 1
        fi
        echo "üì¶ Telep√≠tem: $@"
        if ! case "$PKG_MANAGER" in
            pacman) sudo pacman -S "$@" ;;
            apt) sudo apt install "$@" ;;
            dnf) sudo dnf install "$@" ;;
            zypper) sudo zypper install "$@" ;;
            apk) sudo apk add "$@" ;;
        esac; then
            if [[ "$PKG_MANAGER" == "pacman" ]] && ! command -v yay >/dev/null; then
                read -p "‚ö†Ô∏è Nem tal√°lhat√≥ yay. Telep√≠tsem? (y/n): " valasz
                if [[ "$valasz" =~ ^[Yy]$ ]]; then
                    telepits_yay || { echo "‚ùå Yay telep√≠t√©se sikertelen."; exit 1; }
                else
                    echo "‚õî Yay nincs telep√≠tve. Kil√©pek."
                    exit 1
                fi
            fi
            [[ "$PKG_MANAGER" == "pacman" ]] && yay -S "$@"
        fi
        ;;

    -R)
        shift
        if [ $# -eq 0 ]; then
            echo "Adj meg elt√°vol√≠tand√≥ csomagot."
            exit 1
        fi
        echo "üóëÔ∏è Elt√°vol√≠tom: $@"
        case "$PKG_MANAGER" in
            pacman) sudo pacman -R "$@" ;;
            apt) sudo apt remove "$@" ;;
            dnf) sudo dnf remove "$@" ;;
            zypper) sudo zypper remove "$@" ;;
            apk) sudo apk del "$@" ;;
        esac
        ;;

    -h|--help)
        echo "üì¶ Pakli - Univerz√°lis Linux csomagkezel≈ë interface"
        echo ""
        echo "Haszn√°lat:"
        echo "  pakli -Syu           Friss√≠ti a rendszert"
        echo "  pakli -Ss kulcssz√≥   Csomag keres√©se"
        echo "  pakli -S csomag      Csomag telep√≠t√©se"
        echo "  pakli -R csomag      Csomag elt√°vol√≠t√°sa"
        echo "  pakli -h             S√∫g√≥"
        ;;

    *)
        echo "‚ùå Ismeretlen parancs: $1"
        echo "Haszn√°ld a -h opci√≥t a seg√≠ts√©ghez."
        exit 1
        ;;
esac
