#!/bin/bash

telepits_yay() {
    echo "üîß Yay telep√≠t√©se folyamatban..."
    sudo pacman -S --needed --noconfirm base-devel git || return 1
    git clone https://aur.archlinux.org/yay.git /tmp/yay || return 1
    cd /tmp/yay || { echo "‚ùå Nem siker√ºlt a yay k√∂nyvt√°rba l√©pni."; return 1; }
    makepkg -si --noconfirm || { echo "‚ùå A yay telep√≠t√©se sikertelen."; return 1; }
    cd - >/dev/null
    rm -rf /tmp/yay
    echo "‚úÖ Yay telep√≠tve."
}

detect_package_manager() {
    if command -v pacman >/dev/null 2>&1; then
        echo "pacman"
    elif command -v apt >/dev/null 2>&1; then
        echo "apt"
    elif command -v dnf >/dev/null 2>&1; then
        echo "dnf"
    elif command -v zypper >/dev/null 2>&1; then
        echo "zypper"
    elif command -v apk >/dev/null 2>&1; then
        echo "apk"
    else
        echo ""
    fi
}

PKG_MANAGER=$(detect_package_manager)
INSTALL_PATH="/usr/local/bin/pakli"
GITHUB_RAW_URL="https://raw.githubusercontent.com/Wardaxx-Arch/Pakli-Csomagkezelo/main/pakli"

if [ -z "$PKG_MANAGER" ]; then
    echo "‚ùå Nem tal√°lhat√≥ t√°mogatott csomagkezel≈ë ezen a rendszeren."
    exit 1
fi

if [ $# -eq 0 ]; then
    echo "Haszn√°lat: pakli [parancs] [csomagok]"
    echo "Haszn√°lhat√≥ parancsok: -Syu, -Ss, -S, -R, -Update, -git, -h"
    exit 1
fi

case "$1" in
    -Syu)
        echo "üîÑ Rendszer friss√≠t√©se..."
        case "$PKG_MANAGER" in
            pacman) sudo pacman -Syu ;;
            apt) sudo apt update && sudo apt upgrade ;;
            dnf) sudo dnf upgrade --refresh ;;
            zypper) sudo zypper refresh && sudo zypper update ;;
            apk) sudo apk update && sudo apk upgrade ;;
        esac
        ;;

    -Ss)
        shift
        if [ $# -eq 0 ]; then
            echo "K√©rlek adj meg keres√©si kulcssz√≥t."
            exit 1
        fi
        case "$PKG_MANAGER" in
            pacman) pacman -Ss "$@" || yay -Ss "$@" ;;
            apt) apt search "$@" ;;
            dnf) dnf search "$@" ;;
            zypper) zypper search "$@" ;;
            apk) apk search "$@" ;;
        esac
        ;;

    -S)
        shift
        if [ $# -eq 0 ]; then
            echo "Adj meg legal√°bb egy csomagot."
            exit 1
        fi
        echo "üì¶ Telep√≠tem: $@"
        telepites_sikeres=true
        case "$PKG_MANAGER" in
            pacman) sudo pacman -S "$@" || telepites_sikeres=false ;;
            apt) sudo apt install "$@" || telepites_sikeres=false ;;
            dnf) sudo dnf install "$@" || telepites_sikeres=false ;;
            zypper) sudo zypper install "$@" || telepites_sikeres=false ;;
            apk) sudo apk add "$@" || telepites_sikeres=false ;;
        esac

        if ! $telepites_sikeres; then
            if [[ "$PKG_MANAGER" == "pacman" ]] && ! command -v yay >/dev/null; then
                read -p "‚ö†Ô∏è Nem tal√°lhat√≥ yay. Telep√≠tsem? (y/n): " valasz
                if [[ "$valasz" =~ ^[Yy]$ ]]; then
                    telepits_yay || { echo "‚ùå Yay telep√≠t√©se sikertelen."; exit 1; }
                else
                    echo "‚õî Yay nincs telep√≠tve. Kil√©pek."
                    exit 1
                fi
            fi
            [[ "$PKG_MANAGER" == "pacman" ]] && yay -S "$@"
        fi
        ;;

    -R)
        shift
        if [ $# -eq 0 ]; then
            echo "Adj meg elt√°vol√≠tand√≥ csomagot."
            exit 1
        fi
        echo "üóëÔ∏è Elt√°vol√≠tom: $@"
        case "$PKG_MANAGER" in
            pacman) sudo pacman -R "$@" ;;
            apt) sudo apt remove "$@" ;;
            dnf) sudo dnf remove "$@" ;;
            zypper) sudo zypper remove "$@" ;;
            apk) sudo apk del "$@" ;;
        esac
        ;;

    -Update)
        echo "üîç Friss√≠t√©s keres√©se a GitHub-on..."
        # ideiglenes f√°jl
        TEMP_FILE=$(mktemp)
        if command -v curl >/dev/null 2>&1; then
            curl -sL "$GITHUB_RAW_URL" -o "$TEMP_FILE"
        elif command -v wget >/dev/null 2>&1; then
            wget -qO "$TEMP_FILE" "$GITHUB_RAW_URL"
        else
            echo "‚ùå Sem curl, sem wget nem tal√°lhat√≥."
            exit 1
        fi

        if [ ! -s "$TEMP_FILE" ]; then
            echo "‚ùå A friss√≠t√©s let√∂lt√©se sikertelen."
            rm -f "$TEMP_FILE"
            exit 1
        fi

        # Ha m√©g nincs telep√≠tve, egyszer≈±en telep√≠tj√ºk
        if [ ! -f "$INSTALL_PATH" ]; then
            echo "üöö Telep√≠t√©s: /usr/local/bin/pakli"
            sudo mv "$TEMP_FILE" "$INSTALL_PATH"
            sudo chmod +x "$INSTALL_PATH"
            echo "‚úÖ Pakli telep√≠tve a leg√∫jabb verzi√≥val."
        else
            # Ha m√°r l√©tezik, √∂sszehasonl√≠tjuk SHA1-gyel
            local_sha=$(sha1sum "$INSTALL_PATH" | cut -d' ' -f1)
            new_sha=$(sha1sum "$TEMP_FILE" | cut -d' ' -f1)
            if [ "$local_sha" != "$new_sha" ]; then
                echo "‚¨ÜÔ∏è Friss√≠t√©s telep√≠t√©se..."
                sudo mv "$TEMP_FILE" "$INSTALL_PATH"
                sudo chmod +x "$INSTALL_PATH"
                echo "‚úÖ Pakli friss√≠tve."
            else
                echo "‚úÖ M√°r a legfrissebb verzi√≥ fut."
                rm -f "$TEMP_FILE"
            fi
        fi
        ;;

    -git)
        shift
        if [ $# -eq 0 ]; then
            echo "K√©rlek add meg a GitHub repo-t form√°tumban (felhaszn√°l√≥/repo)."
            exit 1
        fi

        git_repo="$1"
        branch="main"
        file_name="pakli.sh"
        local_dir="$HOME/.pakli/git_repos/$git_repo"
        local_file="$local_dir/$file_name"

        mkdir -p "$local_dir"

        api_url="https://api.github.com/repos/$git_repo/contents/$file_name?ref=$branch"
        remote_sha=$(curl -s "$api_url" | grep -m 1 '"sha":' | cut -d '"' -f4)

        if [ -z "$remote_sha" ]; then
            echo "‚ùå A GitHub API nem tal√°lta a f√°jlt: $file_name"
            exit 1
        fi

        if [ ! -f "$local_file" ]; then
            echo "üì• A f√°jl nem tal√°lhat√≥ helyben, let√∂lt√©s..."
            curl -sL "https://raw.githubusercontent.com/$git_repo/$branch/$file_name" -o "$local_file"
            echo "‚úÖ Let√∂ltve: $local_file"
        else
            local_sha=$(sha1sum "$local_file" | cut -d ' ' -f1)
            if [ "$local_sha" != "$remote_sha" ]; then
                echo "üîÑ Friss√≠t√©s: √öjabb verzi√≥ el√©rhet≈ë, let√∂lt√©s..."
                curl -sL "https://raw.githubusercontent.com/$git_repo/$branch/$file_name" -o "$local_file"
                echo "‚úÖ Friss√≠tve: $local_file"
            else
                echo "‚úîÔ∏è A helyi f√°jl naprak√©sz: $local_file"
            fi
        fi
        ;;

    -h|--help)
        echo "üì¶ Pakli - Univerz√°lis Linux csomagkezel≈ë interface"
        echo ""
        echo "Haszn√°lat:"
        echo "  pakli -Syu                 Friss√≠ti a rendszert"
        echo "  pakli -Ss <kulcssz√≥>       Csomag keres√©se"
        echo "  pakli -S <csomag>          Csomag telep√≠t√©se"
        echo "  pakli -R <csomag>          Csomag elt√°vol√≠t√°sa"
        echo "  pakli -Update              Pakli friss√≠t√©se a GitHub-r√≥l"
        echo "  pakli -git <user/repo>     GitHub f√°jl let√∂lt√©se/friss√≠t√©se"
        echo "  pakli -h                   S√∫g√≥"
        ;;

    *)
        echo "‚ùå Ismeretlen parancs: $1"
        echo "Haszn√°ld a -h opci√≥t a seg√≠ts√©ghez."
        exit 1
        ;;
esac
