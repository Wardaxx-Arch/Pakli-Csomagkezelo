#!/bin/bash

telepits_yay() {
    echo "üîß Yay telep√≠t√©se folyamatban..."
    sudo pacman -S --needed --noconfirm base-devel git || return 1
    git clone https://aur.archlinux.org/yay.git /tmp/yay || return 1
    cd /tmp/yay || { echo "‚ùå Nem siker√ºlt a yay k√∂nyvt√°rba l√©pni."; return 1; }
    makepkg -si --noconfirm || { echo "‚ùå A yay telep√≠t√©se sikertelen."; return 1; }
    cd - >/dev/null
    rm -rf /tmp/yay
    echo "‚úÖ Yay telep√≠tve."
}

detect_package_manager() {
    if command -v pacman >/dev/null 2>&1; then
        echo "pacman"
    elif command -v apt >/dev/null 2>&1; then
        echo "apt"
    elif command -v dnf >/dev/null 2>&1; then
        echo "dnf"
    elif command -v zypper >/dev/null 2>&1; then
        echo "zypper"
    elif command -v apk >/dev/null 2>&1; then
        echo "apk"
    else
        echo ""
    fi
}

LOGFILE="$HOME/.pakli_history.txt"
PKG_MANAGER=$(detect_package_manager)
INSTALL_PATH="/usr/local/bin/pakli"
GITHUB_RAW_URL="https://raw.githubusercontent.com/Wardaxx-Arch/Pakli-Csomagkezelo/main/pakli"

if [ -z "$PKG_MANAGER" ]; then
    echo "‚ùå Nem tal√°lhat√≥ t√°mogatott csomagkezel≈ë ezen a rendszeren."
    exit 1
fi

if [ $# -eq 0 ]; then
    echo "Haszn√°lat: pakli [parancs] [csomagok]"
    echo "Haszn√°lhat√≥ parancsok: -Syu, -Ss, -S, -R, -Update, -git, -h, -Mukodes, -suggest, -history"
    exit 1
fi

case "$1" in
    -Syu)
        echo "üîÑ Rendszer friss√≠t√©se..."
        case "$PKG_MANAGER" in
            pacman) sudo pacman -Syu ;;
            apt) sudo apt update && sudo apt upgrade ;;
            dnf) sudo dnf upgrade --refresh ;;
            zypper) sudo zypper refresh && sudo zypper update ;;
            apk) sudo apk update && sudo apk upgrade ;;
        esac
        ;;

    -Ss)
        shift
        if [ $# -eq 0 ]; then
            echo "K√©rlek adj meg keres√©si kulcssz√≥t."
            exit 1
        fi
        case "$PKG_MANAGER" in
            pacman) pacman -Ss "$@" || yay -Ss "$@" ;;
            apt) apt search "$@" ;;
            dnf) dnf search "$@" ;;
            zypper) zypper search "$@" ;;
            apk) apk search "$@" ;;
        esac
        ;;

    -S)
        shift
        if [ $# -eq 0 ]; then
            echo "Adj meg legal√°bb egy csomagot."
            exit 1
        fi
        echo "üì¶ Telep√≠tem: $@"
        echo "[`date`] Telep√≠tve: $*" >> "$LOGFILE"
        telepites_sikeres=true
        case "$PKG_MANAGER" in
            pacman) sudo pacman -S "$@" || telepites_sikeres=false ;;
            apt) sudo apt install "$@" || telepites_sikeres=false ;;
            dnf) sudo dnf install "$@" || telepites_sikeres=false ;;
            zypper) sudo zypper install "$@" || telepites_sikeres=false ;;
            apk) sudo apk add "$@" || telepites_sikeres=false ;;
        esac

        if ! $telepites_sikeres; then
            if [[ "$PKG_MANAGER" == "pacman" ]] && ! command -v yay >/dev/null; then
                read -p "‚ö†Ô∏è Nem tal√°lhat√≥ yay. Telep√≠tsem? (y/n): " valasz
                if [[ "$valasz" =~ ^[Yy]$ ]]; then
                    telepits_yay || { echo "‚ùå Yay telep√≠t√©se sikertelen."; exit 1; }
                else
                    echo "‚õî Yay nincs telep√≠tve. Kil√©pek."
                    exit 1
                fi
            fi
            [[ "$PKG_MANAGER" == "pacman" ]] && yay -S "$@"
        fi
        ;;

    -R)
        shift
        if [ $# -eq 0 ]; then
            echo "Adj meg elt√°vol√≠tand√≥ csomagot."
            exit 1
        fi
        echo "üóëÔ∏è Elt√°vol√≠tom: $@"
        echo "[`date`] Elt√°vol√≠tva: $*" >> "$LOGFILE"
        case "$PKG_MANAGER" in
            pacman) sudo pacman -R "$@" ;;
            apt) sudo apt remove "$@" ;;
            dnf) sudo dnf remove "$@" ;;
            zypper) sudo zypper remove "$@" ;;
            apk) sudo apk del "$@" ;;
        esac
        ;;

-Update)
    echo "‚¨ÜÔ∏è A Pakli friss√≠t√©se saj√°t GitHub repo-b√≥l..."

    REPO_URL="https://github.com/Wardaxx-Arch/Pakli-Csomagkezelo.git"
    LOCAL_PATH="$HOME/.pakli/git_repos/Pakli"

    echo "‚ÑπÔ∏è Friss√≠t√©s helye: $LOCAL_PATH"

    # Ha m√°r l√©tezik a bin√°ris: t√∂r√∂lj√ºk
    if [ -f "/usr/local/bin/pakli" ]; then
        echo "üóëÔ∏è R√©gi verzi√≥ t√∂rl√©se: /usr/local/bin/pakli"
        sudo rm /usr/local/bin/pakli
    fi

    # Git repo friss√≠t√©se vagy let√∂lt√©se
    if [ -d "$LOCAL_PATH/.git" ]; then
        echo "üì• Friss√≠t√©s git pull-lal..."
        git -C "$LOCAL_PATH" pull
    else
        echo "üì• Kl√≥noz√°s a t√°rol√≥b√≥l..."
        mkdir -p "$(dirname "$LOCAL_PATH")"
        git clone "$REPO_URL" "$LOCAL_PATH"
    fi

    # Ellen≈ërizz√ºk, hogy ott van-e a f√°jl
    if [ -f "$LOCAL_PATH/pakli" ]; then
        echo "üìÅ √öj verzi√≥ m√°sol√°sa: /usr/local/bin/pakli"
        sudo cp "$LOCAL_PATH/pakli" /usr/local/bin/pakli
        sudo chmod +x /usr/local/bin/pakli
        echo "‚úÖ Sikeres friss√≠t√©s √©s telep√≠t√©s."
    else
        echo "‚ùå Nem tal√°lhat√≥ az √∫j pakli f√°jl ($LOCAL_PATH/pakli)"
        echo "‚ÑπÔ∏è Az aktu√°lis mappa tartalma: $(ls -l "$LOCAL_PATH")"
    fi
;;



    -git)
        shift
        if [ $# -lt 2 ]; then
            echo "Haszn√°lat: pakli -git <felhasznalo/repo> <fajlnev> [branch]"
            exit 1
        fi
        git_repo="$1"
        file_name="$2"
        branch="${3:-main}"
        local_dir="$HOME/.pakli/git_repos/$git_repo"
        local_file="$local_dir/$file_name"
        mkdir -p "$local_dir"
        api_url="https://api.github.com/repos/$git_repo/contents/$file_name?ref=$branch"
        remote_sha=$(curl -s "$api_url" | grep -m 1 '"sha":' | cut -d '"' -f4)
        if [ -z "$remote_sha" ]; then
            echo "‚ùå A GitHub API nem tal√°lta a f√°jlt: $file_name"
            exit 1
        fi
        if [ ! -f "$local_file" ]; then
            echo "üì• A f√°jl nem tal√°lhat√≥ helyben, let√∂lt√©s..."
            curl -sL "https://raw.githubusercontent.com/$git_repo/$branch/$file_name" -o "$local_file"
            echo "‚úÖ Let√∂ltve: $local_file"
        else
            # Helyi SHA-t base64-ben kell hasonl√≠tani a GitHub API SHA-hoz
            local_sha=$(sha1sum "$local_file" | cut -d ' ' -f1)
            if [ "$local_sha" != "$remote_sha" ]; then
                echo "üîÑ Friss√≠t√©s: √öjabb verzi√≥ el√©rhet≈ë, let√∂lt√©s..."
                curl -sL "https://raw.githubusercontent.com/$git_repo/$branch/$file_name" -o "$local_file"
                echo "‚úÖ Friss√≠tve: $local_file"
            else
                echo "‚úîÔ∏è A helyi f√°jl naprak√©sz: $local_file"
            fi
        fi
        ;;

    -suggest)
        echo "üéØ Aj√°nlott csomagok:"
        case "$PKG_MANAGER" in
            pacman|yay)
                echo "  - firefox"
                echo "  - gimp"
                echo "  - vlc"
                echo "  - htop"
                echo "  - neofetch"
                ;;
            apt)
                echo "  - gnome-software"
                echo "  - gparted"
                echo "  - vlc"
                echo "  - neofetch"
                echo "  - htop"
                ;;
            dnf)
                echo "  - gimp"
                echo "  - vlc"
                echo "  - neofetch"
                ;;
            zypper)
                echo "  - vlc"
                echo "  - htop"
                echo "  - neofetch"
                ;;
            apk)
                echo "  - htop"
                echo "  - curl"
                echo "  - nano"
                ;;
        esac
        ;;

    -history)
        if [ -f "$LOGFILE" ]; then
            echo "üìú Telep√≠t√©si el≈ëzm√©nyek:"
            cat "$LOGFILE"
        else
            echo "‚ÑπÔ∏è Nincs el≈ëzm√©ny napl√≥zva m√©g."
        fi
        ;;

    -h|--help)
        echo "üì¶ Pakli - Univerz√°lis Linux csomagkezel≈ë interface"
        echo ""
        echo "Haszn√°lat:"
        echo "  pakli -Syu                 Rendszer friss√≠t√©se"
        echo "  pakli -Ss <kulcssz√≥>       Keres√©s"
        echo "  pakli -S <csomag>          Telep√≠t√©s"
        echo "  pakli -R <csomag>          Elt√°vol√≠t√°s"
        echo "  pakli -Update              Saj√°t friss√≠t√©s"
        echo "  pakli -git <user/repo>     GitHub f√°jl friss√≠t√©s"
        echo "  pakli -suggest             Aj√°nlott csomagok"
        echo "  pakli -history             Telep√≠t√©si el≈ëzm√©nyek"
        echo "  pakli -Mukodes             M≈±k√∂d√©s le√≠r√°sa"
        ;;

    -Mukodes)
        echo "    Pakli M≈±k√∂d√©se:"
        echo
        echo " A Pakli √©rz√©keli, hogy milyen Linux disztr√≥t haszn√°lsz,"
        echo " √©s ha t√°mogatja azt a disztr√≥t, m≈±k√∂dni fog."
        echo
        echo "Ha be√≠rod pl.: pakli -S firefox,"
        echo "akkor ez lefordul pl.: \"pacman -S firefox\"-ra,"
        echo "√©s √≠gy k√∂nnyebben lehet programot telep√≠teni."
        echo
        echo "Ha a yay nincs telep√≠tve Arch rendszeren, k√©r√©sre telep√≠ti."
        ;;

    *)
        echo "‚ùå Ismeretlen parancs: $1"
        echo "Haszn√°ld a -h opci√≥t a seg√≠ts√©ghez."
        exit 1
        ;;
esac
